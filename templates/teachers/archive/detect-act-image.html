{% extends 'admin_base.html' %}
{% load static %}

{% block css %}
<style>
#camera-wrapper {
    max-width: 400px;
    margin: 20px auto;
    text-align: center;
    position: relative; /* Для loader */
}

#my_camera video, #my_camera canvas, #my_camera {
    width: 100% !important;
    height: auto !important;
    border-radius: 10px;
}

#loader {
    display: none; /* Скрыт по умолчанию */
    position: absolute;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(255,255,255,0.7);
    justify-content: center;
    align-items: center;
    font-size: 20px;
    font-weight: bold;
    color: #333;
    border-radius: 10px;
    z-index: 10;
}

img.preview-img {
    width: 100%;
    border-radius: 12px;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3 class="text-center mb-4">OCR Сканер студентов</h3>

    <div id="camera-wrapper">
        <div id="my_camera"></div>

        <!-- Loader -->
        <div id="loader">Обработка...</div>

        <button id="captureBtn" class="btn btn-primary btn-block mt-2">Сделать фото</button>
    </div>

    <div id="ocrResult" class="mt-4"></div>
</div>

<!-- Modal подтверждения -->
<div id="confirmModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Подтвердите фото</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>

            <div class="modal-body text-center">
                <img id="modalPreview" class="preview-img" alt="preview">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Переснять</button>
                <button id="confirmSend" class="btn btn-success">Отправить</button>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>

<script>
let capturedImage = null;

// Инициализация камеры
Webcam.set({
    width: 360,
    height: 300,
    image_format: 'jpeg',
    jpeg_quality: 90,
    constraints: { facingMode: { ideal: "environment" } }
});
Webcam.attach('#my_camera');

// Снимок
document.getElementById("captureBtn").onclick = function() {
    Webcam.snap(function(data_uri){
        capturedImage = data_uri;
        document.getElementById("modalPreview").src = data_uri;
        $('#confirmModal').modal('show');
    });
};

// Подтверждение и отправка
document.getElementById("confirmSend").onclick = function() {
    $('#confirmModal').modal('hide');

    // ПОКАЗ loader ТОЛЬКО здесь
    const loader = document.getElementById("loader");
    loader.style.display = "flex";

    fetch("/archive/ocr/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ image: capturedImage })
    })
    .then(res => res.json())
    .then(data => {
        loader.style.display = "none"; // скрываем после ответа
        document.getElementById("ocrResult").innerHTML = `
            <div class="alert alert-info">
                <strong>Распознанные студенты:</strong>
                <pre>${JSON.stringify(data.result, null, 2)}</pre>
            </div>`;
    })
    .catch(err => {
        console.error(err);
        loader.style.display = "none";
    });
};
</script>
{% endblock %}
